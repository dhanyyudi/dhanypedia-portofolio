name: Supabase Keep Alive

on:
  schedule:
    # Run at 00:00 UTC every day
    - cron: '0 0 * * *'
  # Allows manual run from Actions tab
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "Error: Secrets not set. Skipping ping."
            exit 1
          fi
          
          echo "Pinging REST API to keep Supabase active..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X GET "$SUPABASE_URL/rest/v1/projects?select=id&limit=1" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY")
            
          echo "Response status code: $response"
          
          if [ "$response" -eq 200 ] || [ "$response" -eq 206 ]; then
            echo "Success: Supabase is active."
          else
            echo "Warning: Received unexpected status code $response"
            # Don't fail the job to avoid spamming notification emails for minor glitches, 
            # unless it's critical. 
          fi
